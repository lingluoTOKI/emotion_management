# 情绪管理系统数据库部署指南

## 📋 概述

本目录包含情绪管理系统的数据库部署相关文件，支持完整的数据库初始化、配置和部署。

## 📁 文件结构

```
database/
├── README.md                 # 本文件
├── config.env               # 数据库配置文件
├── deploy.sql               # 完整数据库部署脚本
├── init.sql                 # 原始数据库初始化脚本
├── init_db.py               # 原始Python初始化脚本
├── init_database.py         # 改进的Python初始化脚本
├── create_mysql_user.sql    # MySQL用户创建脚本
├── test_db.py              # 数据库测试脚本
└── backups/                # 数据库备份目录（自动创建）
```

## 🚀 快速部署

### 方法一：使用Python脚本（推荐）

1. **安装依赖**
   ```bash
   pip install mysql-connector-python bcrypt
   ```

2. **配置数据库连接**
   ```bash
   # 复制配置文件
   cp config.env .env
   
   # 编辑配置文件，修改数据库连接信息
   nano .env
   ```

3. **运行初始化脚本**
   ```bash
   python init_database.py
   ```

### 方法二：使用SQL脚本

1. **创建数据库用户（可选）**
   ```bash
   mysql -u root -p < create_mysql_user.sql
   ```

2. **执行部署脚本**
   ```bash
   mysql -u root -p < deploy.sql
   ```

## ⚙️ 配置说明

### 数据库连接配置

在 `config.env` 文件中配置以下参数：

```env
# 数据库连接配置
DB_HOST=localhost          # 数据库主机
DB_PORT=3306              # 数据库端口
DB_USER=root              # 数据库用户名
DB_PASSWORD=password      # 数据库密码
DB_NAME=emotion_management # 数据库名称
```

### 系统配置

系统会自动创建以下配置项：

- `system_name`: 系统名称
- `system_version`: 系统版本
- `max_ai_session_duration`: AI会话最大时长
- `risk_assessment_threshold`: 风险评估阈值
- `counselor_notification_enabled`: 咨询师通知开关
- `ai_model_version`: AI模型版本
- `assessment_retention_days`: 评估数据保留天数
- `backup_enabled`: 自动备份开关

## 📊 数据库结构

### 核心表

1. **用户相关表**
   - `users`: 用户基础信息
   - `admins`: 管理员信息
   - `students`: 学生信息
   - `counselors`: 咨询师信息

2. **AI咨询相关表**
   - `ai_counseling_sessions`: AI咨询会话
   - `risk_assessments`: 风险评估

3. **心理评估相关表**
   - `assessments`: 心理评估
   - `assessment_records`: 评估记录
   - `emotion_records`: 情绪记录

4. **咨询相关表**
   - `consultations`: 咨询记录
   - `consultation_records`: 咨询过程记录
   - `appointments`: 预约记录

5. **系统相关表**
   - `system_configs`: 系统配置
   - `operation_logs`: 操作日志

### 关键特性

- **UTF8MB4字符集**: 支持完整的Unicode字符
- **JSON字段**: 存储复杂数据结构
- **外键约束**: 保证数据完整性
- **索引优化**: 提高查询性能
- **时间戳**: 自动记录创建和更新时间

## 🔑 默认账号

### 管理员账号
- 用户名: `admin`
- 密码: `123456`
- 角色: 系统管理员

### 咨询师账号
- 用户名: `counselor1`
- 密码: `123456`
- 角色: 心理咨询师（认知行为疗法）

- 用户名: `counselor2`
- 密码: `123456`
- 角色: 心理咨询师（人本主义）

### 学生账号
- 用户名: `student1`
- 密码: `123456`
- 角色: 学生（计算机科学与技术）

- 用户名: `student2`
- 密码: `123456`
- 角色: 学生（心理学）

- 用户名: `student3`
- 密码: `123456`
- 角色: 学生（软件工程）

### 测试账号
- 用户名: `test_student1`
- 密码: `test123`
- 角色: 测试学生

- 用户名: `test_counselor1`
- 密码: `test123`
- 角色: 测试咨询师

## 🛠️ 维护操作

### 数据库备份

```bash
# 手动备份
python init_database.py --backup

# 自动备份（通过cron）
0 2 * * * /path/to/python /path/to/init_database.py --backup
```

### 数据库恢复

```bash
# 从备份恢复
mysql -u root -p emotion_management < backups/emotion_management_backup_20250107_120000.sql
```

### 数据清理

```bash
# 清理过期数据
python -c "
from database.init_database import get_db_config
import mysql.connector
config = get_db_config()
conn = mysql.connector.connect(**config)
cursor = conn.cursor()
cursor.execute('DELETE FROM operation_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY)')
conn.commit()
conn.close()
print('过期日志清理完成')
"
```

## 🔍 故障排除

### 常见问题

1. **连接失败**
   - 检查MySQL服务是否运行
   - 验证用户名和密码
   - 确认端口号正确

2. **字符集问题**
   - 确保数据库使用utf8mb4字符集
   - 检查连接字符串中的charset参数

3. **权限问题**
   - 确保用户有创建数据库的权限
   - 检查外键约束权限

4. **表创建失败**
   - 检查SQL语法
   - 确认表名不冲突
   - 验证字段类型支持

### 日志查看

```bash
# 查看MySQL错误日志
tail -f /var/log/mysql/error.log

# 查看应用日志
tail -f logs/database.log
```

## 📈 性能优化

### 索引优化

系统已为以下字段创建索引：
- 用户表的username、email、role
- 会话表的session_id、status、start_time
- 评估表的student_id、assessment_type、status
- 咨询表的student_id、counselor_id、scheduled_time

### 查询优化建议

1. 使用适当的WHERE条件
2. 避免SELECT *
3. 合理使用JOIN
4. 定期分析查询性能

## 🔒 安全建议

1. **密码安全**
   - 使用强密码
   - 定期更换密码
   - 启用密码策略

2. **访问控制**
   - 限制数据库访问IP
   - 使用专用数据库用户
   - 最小权限原则

3. **数据加密**
   - 启用SSL连接
   - 加密敏感数据
   - 定期备份加密

## 📞 技术支持

如遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查系统日志
3. 联系技术支持团队

---

**版本**: 2.0  
**更新日期**: 2025-01-07  
**维护者**: 情绪管理系统开发团队
